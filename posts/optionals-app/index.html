<!doctype html>
<html lang="en-us">
  <head>
    <title>Optionals // David Raab</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.104.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="David Raab" />
    <meta name="description" content="Describes Optionals as an alternative to null" />
    <link rel="stylesheet" href="https://davidraab.github.io/css/main.min.c5d0d3078a177d7cfb9aa69e4ac0843c2cef8c18ec3ed7421bb5e95b879ca2f7.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Optionals"/>
<meta name="twitter:description" content="Describes Optionals as an alternative to null"/>

    <meta property="og:title" content="Optionals" />
<meta property="og:description" content="Describes Optionals as an alternative to null" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://davidraab.github.io/posts/optionals-app/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-04-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2016-04-11T00:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://davidraab.github.io"><img class="app-header-avatar" src="/avatar.jpg" alt="David Raab" /></a>
      <span class="app-header-title">David Raab</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>My personal Blog. Writing about programming and other stuff.</p>
      <div class="app-header-social">
        
          <a href="https://github.com/DavidRaab" target="_blank" rel="noreferrer noopener me">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>David Raab Github Profile</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Optionals</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Apr 11, 2016
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          21 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://davidraab.github.io/tags/fsharp/">FSharp</a>
              <a class="tag" href="https://davidraab.github.io/tags/null/">null</a>
              <a class="tag" href="https://davidraab.github.io/tags/option/">option</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>In this post I want to talk about <em>Optionals</em> more deeply. I already wrote
<a href="https://davidraab.github.io/posts/null-is-evil/">about null</a>, but I noticed that it is still
not immediately clear on why <em>Optionals</em> are better. Instead of focusing why <code>null</code>
is bad, this time I want to focus why <em>Optionals</em> are good. For this purpose I also wrote
a small application that I will cover. But first, let&rsquo;s go over <em>Optionals</em> and see
which benefits they have.</p>
<h2 id="null-is-not-the-problem"><code>null</code> is not the problem</h2>
<p>At first, I will state that <code>null</code> itself is not even the problem.</p>
<p>Let&rsquo;s assume we write a application and we need to read some <em>Product</em> entries from a
database. We just have a simple <em>id</em> as an <code>int</code> to identify a product.</p>
<p>Now let&rsquo;s assume we get some user input that tells us to show a Product with the id <code>12345</code>.
Sure, as long we only get request to products that exists, we don&rsquo;t run into any kind of problems.
But let&rsquo;s imagine we write a function that returns a <em>Product</em>, and the requested <em>Product</em> doesn&rsquo;t
exists. What do we do in such a case?</p>
<p>The usual approach, at least in OO programming, is to either return <code>null</code>, or throwing an
<em>Exception</em>. But i <a href="https://davidraab.github.io/posts/exceptions-are-evil/">don&rsquo;t think that Exceptions are better compared to null</a>.</p>
<p>So, why is returning <code>null</code> bad? Because a client calling our function is not forced to check
for <code>null</code>. And if he works with <code>null</code> as if he had a <em>Product</em>, the program will crash. What
happens if we throw an <em>Exception</em>? Well, our program still crashes!</p>
<p>The thing is. No matter if we return <code>null</code> or we throw <em>exceptions</em>. We must handle the case when
we don&rsquo;t get a <em>Product</em>. But <code>null</code> or <em>exceptions</em> don&rsquo;t force you to handle both cases.
Neither <code>null</code> or <em>exceptions</em> forces you to add checks. Both concepts just crashes your program
at runtime. The only <em>hope</em> you have is that you <em>hopefully</em> have a <em>test-suite</em> that <em>hopefully</em>
handles those cases. For me, that is too much of <em>hope</em>.</p>
<p>Yes, throwing an <em>Exception</em> is a <em>little bit</em> better. But think on why it is <em>a little bit better</em>.
We see it as an advantage as we <em>hopefully</em> (<em>gosh!</em>) already see any kind of error during development,
so we can add the needed <code>try/catch</code> statements.</p>
<p>But wouldn&rsquo;t it be better if we are forced to add the checks because the language forces us to
do it? Because we otherwise get a compile-time error? If we somehow could get this kind of behaviour
it would mean we never can forgot to add a <code>null</code> check or a <code>try/catch</code> statements. It will become
impossible to write programs that unexpectedly crashes at runtime.</p>
<p>Our program either compiles fine, and we handled all places where a <strong>no value</strong> could be returned,
or if we forgot to handle such a place we just get a compile-time error that gives us the exact place
and line where we forgot to handle such a case.</p>
<p>It seems like a dream. But this is exactly what <em>Optionals</em> gives us!</p>
<h2 id="optionals">Optionals</h2>
<p><em>Optionals</em> fixes that problem because it makes the idea of <strong>No value</strong> it&rsquo;s own type. The <code>option</code>
type in F# is defined as followed:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">type</span> <span class="nc">option</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">Some</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What does that mean? You can compare it to a <code>bool</code> or an <em>enum</em> type. We have two cases. Like
a <code>bool</code> that either can be <code>true</code> or <code>false</code>. Here we have an <code>option</code> that either can be <code>Some</code>
or <code>None</code>. The difference is that the <code>Some</code> case can carry an additional value. Something
that an <em>enum</em> or a <code>bool</code> cannot do.</p>
<p>The <code>Some</code> or <code>None</code> are basically constructors. In the same sense that <code>true</code> or <code>false</code> are
constructors that creates a <code>bool</code>. As <code>None</code> don&rsquo;t carry any value, you just can write <code>None</code>,
the same you just can write <code>null</code>. But, if a function has a path that returns <code>None</code>, you
must ensure that all code paths return an <code>option</code> type. As we cannot create functions with
mixed return types. So you cannot write something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">containsE</span> <span class="o">(</span><span class="n">str</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&#34;E&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">then</span> <span class="n">str</span>  <span class="c1">// string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="n">None</span> <span class="c1">// option
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This would either return a <code>string</code> or an <code>option</code>. So what you must do is wrap your value in a <code>Some</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">containsE</span> <span class="o">(</span><span class="n">str</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">str</span><span class="o">.</span><span class="n">Contains</span><span class="o">(</span><span class="s">&#34;E&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">then</span> <span class="n">Some</span> <span class="n">str</span> <span class="c1">// option&lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="n">None</span>     <span class="c1">// option&lt;string&gt;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This has some implications:</p>
<ol>
<li>Now you have a function that returns an <code>option</code> containing a <code>string</code>.</li>
<li>A user can see that <code>containsE</code> not always returns a value.</li>
<li>A user that wants to work with the result of <code>containsE</code> first must check which case he got.</li>
</ol>
<p>The last implication means you must check if you either got <code>Some</code> or <code>None</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">opt</span> <span class="o">=</span> <span class="n">containsE</span> <span class="s">&#34;foo&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">match</span> <span class="n">opt</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">None</span>     <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s">&#34;No E&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">Some</span> <span class="n">str</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s">&#34;%s contains an e&#34;</span> <span class="n">x</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>But we also have a lot of helper functions in the <code>Option</code> module like <code>Option.map</code>,
<code>Option.iter</code>, <code>Option.bind</code> and so on that helps us working with <code>option</code> types.</p>
<p>For example it is quite common that we want to check if we have <code>Some value</code> and call a
function with <code>value</code>. But what do we do if we have <code>None</code>? Then we can&rsquo;t call
our function. This kind of stuff is what a <code>Option.map</code> does. So instead of</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">x</span> <span class="o">=</span> <span class="n">Some</span> <span class="n">10</span>
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">y</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">None</span>   <span class="o">-&gt;</span> <span class="n">None</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">5</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>we also can just write</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">y</span> <span class="o">=</span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">+</span> <span class="n">5</span><span class="o">)</span> <span class="n">x</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we are forced to handle <code>option</code> values. But <code>option</code> itself is it&rsquo;s own type and we have
a lot of functions that helps us working with <code>option</code> values.</p>
<h2 id="the-application">The Application</h2>
<p>The best way to show the benefits and the difference is to go through a small example. For that
purpose I created a small in-memory database and a CLI program with basic CRUD operations. You
can see the full source code at the end. But i don&rsquo;t want to cover every detail. I want to focus on
the <em>Optional</em> part. First, let&rsquo;s see how we can use the program</p>
<pre><code>Command: show
  Id |                      Name | Price
   1 |                        TV | 499.99
   2 |                    A Book | 29.99
   3 |              Game Console | 349.99
Command: asdasdfkhjb
Error: invalid command -- [asdasdfkhjb]
Command: delete 2
Command: show 2
Product with id 2 doesn't exists.
Command: insert &quot;Zelda: Skyward Swords&quot; 49,99
Command: show
  Id |                      Name | Price
   1 |                        TV | 499.99
   3 |              Game Console | 349.99
   4 |     Zelda: Skyward Swords | 49.99
Command: name 1 &quot;Television&quot;
Command: price 3 299,99
Command: show
  Id |                      Name | Price
   1 |                Television | 499.99
   3 |              Game Console | 299.99
   4 |     Zelda: Skyward Swords | 49.99
Command: exit
</code></pre>
<p>The program just contains the commands <code>show</code>, <code>insert</code>, <code>name</code>, <code>price</code>, <code>delete</code> and <code>exit</code> as
valid commands. As you can imagine we need to handle a lot of failures.</p>
<p>As usual, all kind of user input can be invalid. A command that doesn&rsquo;t exists. Parsing of
a number failed, in general a user just enters garbage. Or a user tries to change or show
a specific entry that doesn&rsquo;t exists.</p>
<p>As i don&rsquo;t want to cover the whole program, just let&rsquo;s look first at the modules and functions
and their signatures to get a overview of the code.</p>
<p>So let&rsquo;s just go through some of the interesting parts. At first, i added a <code>Option.IfNone</code>
function. It either returns a value if present or the provided value. It is just a call
to <code>defaultArg</code>. I created <code>ifNone</code> because the default argument order of <code>defaultArg</code>
doesn&rsquo;t work nicely with piping.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Option</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">ifNone</span> <span class="n">x</span> <span class="n">opt</span> <span class="o">=</span> <span class="n">defaultArg</span> <span class="n">opt</span> <span class="n">x</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here is a brief overview of the modules and functions i created.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Product</span> <span class="o">=</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">create</span>    <span class="o">:</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">decimal</span> <span class="o">-&gt;</span> <span class="n">Product</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">withName</span>  <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">Product</span> <span class="o">-&gt;</span> <span class="n">Product</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">withPrice</span> <span class="o">:</span> <span class="kt">decimal</span> <span class="o">-&gt;</span> <span class="n">Product</span> <span class="o">-&gt;</span> <span class="n">Product</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">DB</span> <span class="o">=</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">getById</span>    <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">option</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">getAll</span>     <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="kt">list</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">containsId</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">nextId</span>     <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">int</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">insert</span>     <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">delete</span>     <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">update</span>     <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">updateId</span>   <span class="o">:</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">,</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">,</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">CLI</span> <span class="o">=</span> <span class="k">begin</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">parseCommand</span>   <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">Command</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">printProduct</span>   <span class="o">:</span> <span class="n">Product</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">show</span>           <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">showProduct</span>    <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">int</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">insert</span>         <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">decimal</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">updateName</span>     <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">updatePrice</span>    <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">decimal</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">executeCommand</span> <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="n">Command</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="n">option</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">eval</span>           <span class="o">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">int</span><span class="o">,</span><span class="n">Product</span><span class="o">&gt;</span> <span class="n">option</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For the <em>in-memory</em> database i just used a <code>Map</code> without creating a new type,
that&rsquo;s why you see a lot of <code>Map</code> types. But overall you still see that we don&rsquo;t have
so few functions returning <code>option</code>.</p>
<p>At first we have the <code>Product</code> module. It just provides some helper functions to create and
modify the following <code>Product</code> Record type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">type</span> <span class="nc">Product</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Id</span><span class="o">:</span>    <span class="n">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">Name</span><span class="o">:</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="n">Price</span><span class="o">:</span> <span class="kt">decimal</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>Product</code> type should contain all our Business logic, validation and so on. It should
only contain <em>pure</em> functions, usually this modules should contain the most code, but
in this example <code>Product</code> doesn&rsquo;t really do much, so it is the smallest module.</p>
<p><code>DB</code> is basically an <em>Application layer</em> or <em>Service layer</em>. It just provides the code
to save things to a database or read things from a database. It is just a simple
<em>Key/Value</em> interface. As you can see from the types. It is fully <em>generic</em> and could
work with any type.</p>
<p>From the types, only <code>getById</code> returns an <code>option</code>. But that doesn&rsquo;t mean it is the only
function that has some <code>option</code> handling in it.</p>
<p>Finally, on top we have the <code>CLI</code> module. The purpose of it is to provide the logic
for the <code>CLI</code>. We parse our input string, interpret the commands and update the database.</p>
<h2 id="db">DB</h2>
<p><code>Map</code> itself is an <em>immutable</em> type. So the general idea is that operations like
<code>insert</code>, <code>delete</code>, <code>update</code> return the new state of <code>Map</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">getById</span> <span class="n">id</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="nn">Map</span><span class="p">.</span><span class="n">tryFind</span> <span class="n">id</span> <span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our <code>getbyid</code> function is fairly simple, as it is just a call to <code>tryFind</code>. But it makes
sense to talk about <code>tryFind</code> and compare it with a <code>Dictionary</code>. If you use a <code>Dictionary</code>
in C# and you try to fetch an entry you usually have two different behaviours.</p>
<p>Either you choose that retrieving an entry could throw an exception, or you use the
<code>TryGetValue</code> method. It doesn&rsquo;t throw an exception, but instead it returns a <code>bool</code> that
you must check, to get the value you have to pass an <code>out</code> parameter to <code>TryGetValue</code>.
I don&rsquo;t really like both ways. We don&rsquo;t want <em>exceptions</em> and wrap the code in <code>try/catch</code>.
But also <code>TryGetValue</code> is annoying as we first create a (mutable) value and pass
it to <code>TryGetValue</code>.</p>
<p>In F# on the other hand a function like <code>tryFind</code> just returns an <code>option</code>, we
either have <code>Some value</code> or <code>None</code>. Here we just return the <code>option</code> as-is. That is
also the reason why <code>getById</code> returns an <code>option</code>. We don&rsquo;t must immediately check the
<code>option</code>. We also can just pass it as a value around. We only must check it if we need
the value inside <code>Some</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">update</span> <span class="n">key</span> <span class="n">value</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="nn">Map</span><span class="p">.</span><span class="n">add</span> <span class="n">key</span> <span class="n">value</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">updateId</span> <span class="n">f</span> <span class="n">key</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span>
</span></span><span class="line"><span class="cl">    <span class="o">|&gt;</span> <span class="n">getById</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">    <span class="o">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">value</span> <span class="o">-&gt;</span> <span class="n">update</span> <span class="n">key</span> <span class="o">(</span><span class="n">f</span> <span class="n">value</span><span class="o">)</span> <span class="n">db</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ifNone</span> <span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Inside <code>DB</code> i added a <code>updateId</code> function. Usually i wouldn&rsquo;t add such a function, but
on the other hand, it is useful and at the same time interesting. The purpose of this
function is that we can fetch and update an entry at the same time. The interesting is:
<code>updateId</code> don&rsquo;t return an <code>option</code>.</p>
<p>At first we fetch the specified entry with <code>getById</code> that returns an <code>option</code>.
When we got a result we want to transform the <code>value</code>. That&rsquo;s why we have <code>(f value)</code>
in-there. The result of this is passed to update, that then returns a new updated
<code>Map</code>. But what happens if <code>getById</code> returns a <code>None</code> instead of a value? The <code>Option.map</code>
part will also directly return <code>None</code> instead of executing the <code>update</code> call.
But we always want to ensure to return a <code>Map</code>, so we either return a new updated <code>Map</code>
or in the case we had <code>None</code>. <code>Option.ifNone</code> returns the <code>Map</code> we started with, without
any change applied.</p>
<p>Assume you work in a language without <code>option</code> and you get a <code>null</code>. You theoretically could
write.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">updateId</span> <span class="n">f</span> <span class="n">key</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">db</span> <span class="o">|&gt;</span> <span class="n">getById</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">    <span class="n">update</span> <span class="n">key</span> <span class="o">(</span><span class="n">f</span> <span class="n">value</span><span class="o">)</span> <span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>But you will only notice that this is error-prone. As this code can just throw a
<code>NullReferenceException</code> if you try to update a non-existent value. Sure you then could add
the typical <code>null</code> checks to get it safe.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">updateId</span> <span class="n">f</span> <span class="n">key</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">db</span> <span class="o">|&gt;</span> <span class="n">getById</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;&gt;</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">    <span class="k">then</span> <span class="n">update</span> <span class="n">key</span> <span class="o">(</span><span class="n">f</span> <span class="n">value</span><span class="o">)</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The difference is, with an <code>option</code> you are forced to handle that case. You cannot
write error-prone code in the first-place! But in general it also shows that <code>updateId</code>
even the fact that an <code>id</code> could not be presented, still don&rsquo;t return an <code>option</code>. Actually
we have an operation that cannot fail here. Either it updates an entry, or it does
nothing. And you get that behaviour ensured by the type-system at compilation-time!</p>
<h3 id="cli">CLI</h3>
<p>The CLI handling is in general split into two parts. First I parse the input by the user
and I use a <em>Discriminated Union</em> to save the different input commands. The type is just
named <code>Command</code>. <code>parseCommand</code> do the transformation of converting the input <code>string</code>
to such a <code>Command</code>. The interesting thing is. Parsing could fail, but you don&rsquo;t see
a <code>Command option</code> for this function.</p>
<p>This is a general idea. Sure <code>option</code> is nice, but if you anyway build a custom type,
you can make the &ldquo;None&rdquo;, &ldquo;NotExistence&rdquo; or &ldquo;Invalid&rdquo; a part of your type. Here I just
have a <code>Command</code> that contains an <code>Invalid</code> case.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">type</span> <span class="nc">Command</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Invalid</span>     <span class="k">of</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Show</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">ShowProduct</span> <span class="k">of</span> <span class="n">int</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">NewName</span>     <span class="k">of</span> <span class="n">int</span> <span class="o">*</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">NewPrice</span>    <span class="k">of</span> <span class="n">int</span> <span class="o">*</span> <span class="kt">decimal</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Insert</span>      <span class="k">of</span> <span class="n">name</span><span class="o">:</span><span class="kt">string</span> <span class="o">*</span> <span class="n">price</span><span class="o">:</span><span class="kt">decimal</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Delete</span>      <span class="k">of</span> <span class="n">int</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Exit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In general you can see that the <em>Discriminated Union</em> just contains a case for every CLI command,
it also contains the parsed input as <code>int</code>, <code>string</code> or <code>decimal</code>. In my code
I just use <em>Pattern Matching</em>, but with <em>Active Patterns</em> I can specify <em>transformation</em>
functions on top of it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="o">(|</span><span class="n">Int</span><span class="o">|_|)</span> <span class="n">input</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">match</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">TryParse</span> <span class="n">input</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="k">false</span><span class="o">,_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="k">true</span><span class="o">,</span><span class="n">x</span>  <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="o">(|</span><span class="n">Decimal</span><span class="o">|_|)</span> <span class="n">input</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">match</span> <span class="nn">Decimal</span><span class="p">.</span><span class="n">TryParse</span> <span class="n">input</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="k">false</span><span class="o">,_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="k">true</span><span class="o">,</span><span class="n">x</span>  <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="o">(|</span><span class="n">LC</span><span class="o">|)</span> <span class="o">(</span><span class="n">str</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>LC</code> in that example is a <em>Complete Active Pattern</em>. As it will always succeed. <code>LC</code> just
takes a <code>string</code> and turns it into a <code>lower-case</code> string. I use it like that</p>
<pre><code>| [| LC &quot;show&quot; |] -&gt; Show
</code></pre>
<p>This not only a <em>Pattern Match</em> that checks if we have an array with &ldquo;show&rdquo; as the only
entry. It first transform the entry to a lower-case string and then compares it with &ldquo;show&rdquo;.</p>
<p>Transforming a string to a lower-case string always succeed, but we also can use
<em>Partial Active Patterns</em> for operation that could fail. That is what <code>(|Int|_|)</code> and
<code>(|Decimal|_|)</code> stands for. Both operation try to parse a string as either <code>Int</code> or
<code>Decimal</code>. In a success case we return <code>Some</code>, otherwise <code>None</code>. But the handling of those
<code>option</code> is done for us. You also see something like that in other functions.</p>
<p>For example a <code>List.choose</code> is basically a <code>map</code> and then a <code>filter</code> operation in one
step. You not only can transform an entry to a new value. By returning <code>Some</code> or <code>None</code>
you also can filter. The <code>choose</code> operation only take the <code>Some</code> elements. Here we have
the same. Using <em>Options</em> for a <em>success/failure</em> or <em>filter</em> case is quite common.</p>
<p>So parsing and validation can be done in one-step. For example <em>parsing</em> the <code>price</code>
case looks like this.</p>
<pre><code>| [| LC &quot;price&quot;; Int id; Decimal price |] -&gt;
</code></pre>
<p>We <em>Pattern Match</em> and only if we have an Array with three elements and the second element can
successfully transformed into an <code>int</code> and the third element can be turned into a <code>Decimal</code>,
only then the case successfully matches. <code>id</code> and <code>price</code> are also <code>int</code> and <code>decimal</code>
not <code>option</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">showProduct</span> <span class="n">db</span> <span class="n">id</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">match</span> <span class="n">db</span> <span class="o">|&gt;</span> <span class="nn">DB</span><span class="p">.</span><span class="n">getById</span> <span class="n">id</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">None</span>   <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s">&#34;Product with id %d doesn&#39;t exists.&#34;</span> <span class="n">id</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Some</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">printProduct</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Also the <code>CLI</code> functions have the idea that they just return the new <code>Map</code>. <code>showProduct</code>
is a operation that could fail, as the specified entry cannot exists. That&rsquo;s why we handle
both cases here. We either print a message that the Product didn&rsquo;t exists, or we print
the returned <code>product</code>. Because we expect the new <code>Map</code> state as a return value, but
<code>showProduct</code> never changes <code>Map</code>, we always just return <code>db</code> (the input <code>Map</code>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">updateName</span> <span class="n">db</span> <span class="n">id</span> <span class="n">newName</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="nn">DB</span><span class="p">.</span><span class="n">updateId</span> <span class="o">(</span><span class="nn">Product</span><span class="p">.</span><span class="n">withName</span> <span class="n">newName</span><span class="o">)</span> <span class="n">id</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">updatePrice</span> <span class="n">db</span> <span class="n">id</span> <span class="n">newPrice</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="nn">DB</span><span class="p">.</span><span class="n">updateId</span> <span class="o">(</span><span class="nn">Product</span><span class="p">.</span><span class="n">withPrice</span> <span class="n">newPrice</span><span class="o">)</span> <span class="n">id</span> <span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our <code>DB.updateId</code> already handled the <code>option</code> for us, that means we just can write
the <code>updateName</code> and <code>updatePrice</code> functions without thinking about <code>option</code>. And still
everything works as expected without any failure!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">executeCommand</span> <span class="n">db</span> <span class="n">command</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">match</span> <span class="n">command</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Show</span>               <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">show</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">ShowProduct</span> <span class="n">x</span>      <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">showProduct</span> <span class="n">db</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Insert</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">price</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">insert</span> <span class="n">db</span> <span class="n">name</span> <span class="n">price</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">NewName</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">name</span><span class="o">)</span>   <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">updateName</span> <span class="n">db</span> <span class="n">id</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">NewPrice</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">price</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">updatePrice</span> <span class="n">db</span> <span class="n">id</span> <span class="n">price</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Delete</span> <span class="n">x</span>           <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="nn">DB</span><span class="p">.</span><span class="n">delete</span> <span class="n">x</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Invalid</span> <span class="n">input</span>      <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">printfn</span> <span class="s">&#34;Error: invalid command -- [%s]&#34;</span> <span class="n">input</span>
</span></span><span class="line"><span class="cl">        <span class="n">Some</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">Exit</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In <code>executeCommand</code> I use the <code>option</code> type for signalling if we still <em>continue</em> or want
to <em>stop</em>. The idea is once again that we just return a new <code>Map</code> after every command.
That <code>Map</code> contains the new state. But once I return <code>None</code> it marks an end. Here
you also see the mapping from the <code>Command</code> to the actual functions. The <code>Invalid</code>
case for example doesn&rsquo;t abort the program. We just print an error message and just return
<code>db</code> unchanged. Only the <code>Exit</code> command ends the program.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">eval</span> <span class="n">db</span> <span class="n">str</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="n">parseCommand</span> <span class="n">str</span> <span class="o">|&gt;</span> <span class="n">executeCommand</span> <span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Near the end I simplified the whole program into two function. Parsing a <code>string</code>
to a <code>Command</code>, and executing a <code>Command</code> that returns us the next <code>Map</code>. At this
level we just compose both operations into a single function. Now we have <code>eval</code>.</p>
<p><code>eval</code> takes a <code>Map</code> and an input <code>string</code>, and will just return a new updated <code>Map</code>
for us. We already achieved a higher-level beyond error or option checking.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">main</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span> <span class="s">&#34;Command: &#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">stdin</span><span class="o">.</span><span class="n">ReadLine</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="nn">CLI</span><span class="p">.</span><span class="n">eval</span> <span class="n">db</span> <span class="o">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">iter</span> <span class="n">loop</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">    <span class="bp">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The only thing needed is the main program loop. We just print &ldquo;Command: &quot; to the terminal.
We read a string. Pass it to <code>Cli.eval db</code>. This will Parse our string, do all kind
of checking and just returns us a <em>eventually</em> a new <code>Map</code>. As long we get a new <code>Map</code>.
we just call <code>loop</code> again that recurs with the new <code>Map</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">storage</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="nn">Map</span><span class="p">.</span><span class="n">ofList</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">1</span><span class="o">,</span> <span class="nn">Product</span><span class="p">.</span><span class="n">create</span> <span class="n">1</span> <span class="s">&#34;TV&#34;</span> <span class="n">499</span><span class="o">.</span><span class="n">99m</span>
</span></span><span class="line"><span class="cl">        <span class="n">2</span><span class="o">,</span> <span class="nn">Product</span><span class="p">.</span><span class="n">create</span> <span class="n">2</span> <span class="s">&#34;A Book&#34;</span> <span class="n">29</span><span class="o">.</span><span class="n">99m</span>
</span></span><span class="line"><span class="cl">        <span class="n">3</span><span class="o">,</span> <span class="nn">Product</span><span class="p">.</span><span class="n">create</span> <span class="n">3</span> <span class="s">&#34;Game Console&#34;</span> <span class="n">349</span><span class="o">.</span><span class="n">99m</span>
</span></span><span class="line"><span class="cl">    <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">main</span> <span class="n">storage</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We create an <em>immutable</em> <code>Map</code> as our starting database. With <code>main storage</code> we finally
start our whole application loop.</p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="http://fsharpforfunandprofit.com/posts/the-option-type/">The Option Type</a></li>
<li><a href="https://en.wikibooks.org/wiki/F_Sharp_Programming/Option_Types">Wikibook - Option Type</a></li>
<li><a href="http://www.davesquared.net/2012/12/optional-fp-in-csharp.html">[C#] Some optional, functional goodness in C#</a></li>
</ul>
<h2 id="full-code">Full Code</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">System</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">System.Text.RegularExpressions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Option</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">ifNone</span> <span class="n">x</span> <span class="n">opt</span> <span class="o">=</span> <span class="n">defaultArg</span> <span class="n">opt</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">type</span> <span class="nc">Product</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Id</span><span class="o">:</span>    <span class="n">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">Name</span><span class="o">:</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="n">Price</span><span class="o">:</span> <span class="kt">decimal</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[&lt;</span><span class="n">CompilationRepresentation</span><span class="o">(</span><span class="nn">CompilationRepresentationFlags</span><span class="p">.</span><span class="n">ModuleSuffix</span><span class="o">)&gt;]</span>
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Product</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">create</span> <span class="n">id</span> <span class="n">name</span> <span class="n">price</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="n">Id</span><span class="o">=</span><span class="n">id</span><span class="o">;</span> <span class="n">Name</span><span class="o">=</span><span class="n">name</span><span class="o">;</span> <span class="n">Price</span><span class="o">=</span><span class="n">price</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">withName</span> <span class="n">newName</span> <span class="n">product</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="n">product</span> <span class="k">with</span> <span class="n">Name</span><span class="o">=</span><span class="n">newName</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">withPrice</span> <span class="n">newPrice</span> <span class="n">product</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span><span class="n">product</span> <span class="k">with</span> <span class="n">Price</span><span class="o">=</span><span class="n">newPrice</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">DB</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">getById</span> <span class="n">id</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nn">Map</span><span class="p">.</span><span class="n">tryFind</span> <span class="n">id</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">getAll</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span> <span class="o">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">toList</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">sortBy</span> <span class="n">fst</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">containsId</span> <span class="n">id</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nn">Map</span><span class="p">.</span><span class="n">containsKey</span> <span class="n">id</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">nextId</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="nn">Map</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">acc</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">max</span> <span class="n">acc</span> <span class="n">k</span><span class="o">)</span> <span class="n">0</span> <span class="n">db</span><span class="o">)</span> <span class="o">+</span> <span class="n">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">insert</span> <span class="n">key</span> <span class="n">value</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Check if we have that key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span>   <span class="n">db</span> <span class="o">|&gt;</span> <span class="n">containsId</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">        <span class="k">then</span> <span class="n">db</span>                      <span class="c1">// yes -- return &#34;db&#34; unchanged
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="n">db</span> <span class="o">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">add</span> <span class="n">key</span> <span class="n">value</span> <span class="c1">// no  -- add product
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">delete</span> <span class="n">id</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span> <span class="o">|&gt;</span> <span class="nn">Map</span><span class="p">.</span><span class="n">remove</span> <span class="n">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">update</span> <span class="n">key</span> <span class="n">value</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nn">Map</span><span class="p">.</span><span class="n">add</span> <span class="n">key</span> <span class="n">value</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">updateId</span> <span class="n">f</span> <span class="n">key</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span>
</span></span><span class="line"><span class="cl">        <span class="o">|&gt;</span> <span class="n">getById</span> <span class="n">key</span>
</span></span><span class="line"><span class="cl">        <span class="o">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">value</span> <span class="o">-&gt;</span> <span class="n">update</span> <span class="n">key</span> <span class="o">(</span><span class="n">f</span> <span class="n">value</span><span class="o">)</span> <span class="n">db</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">ifNone</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">CLI</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The CLI Commands
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">type</span> <span class="nc">Command</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Invalid</span>     <span class="k">of</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Show</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">ShowProduct</span> <span class="k">of</span> <span class="n">int</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">NewName</span>     <span class="k">of</span> <span class="n">int</span> <span class="o">*</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">NewPrice</span>    <span class="k">of</span> <span class="n">int</span> <span class="o">*</span> <span class="kt">decimal</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Insert</span>      <span class="k">of</span> <span class="n">name</span><span class="o">:</span><span class="kt">string</span> <span class="o">*</span> <span class="n">price</span><span class="o">:</span><span class="kt">decimal</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Delete</span>      <span class="k">of</span> <span class="n">int</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Parsing string to Command
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">let</span> <span class="o">(|</span><span class="n">Int</span><span class="o">|_|)</span> <span class="n">input</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">match</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">TryParse</span> <span class="n">input</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="k">false</span><span class="o">,_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="k">true</span><span class="o">,</span><span class="n">x</span>  <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="o">(|</span><span class="n">Decimal</span><span class="o">|_|)</span> <span class="n">input</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">match</span> <span class="nn">Decimal</span><span class="p">.</span><span class="n">TryParse</span> <span class="n">input</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="k">false</span><span class="o">,_</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="k">true</span><span class="o">,</span><span class="n">x</span>  <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="o">(|</span><span class="n">LC</span><span class="o">|)</span> <span class="o">(</span><span class="n">str</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="n">ToLowerInvariant</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">parseCommand</span> <span class="o">(</span><span class="n">input</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">let</span> <span class="nv">args</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="nn">Regex</span><span class="p">.</span><span class="n">Matches</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="s">&#34;(?:</span><span class="se">\&#34;</span><span class="s">(?&lt;str&gt;[^</span><span class="se">\&#34;</span><span class="s">]+)</span><span class="se">\&#34;</span><span class="s">|(?&lt;str&gt;</span><span class="err">\</span><span class="s">S+))&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Match</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">Groups</span><span class="o">.[</span><span class="s">&#34;str&#34;</span><span class="o">].</span><span class="n">Value</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|&gt;</span> <span class="nn">Seq</span><span class="p">.</span><span class="n">toArray</span>
</span></span><span class="line"><span class="cl">        <span class="k">match</span> <span class="n">args</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="o">[|</span> <span class="n">LC</span> <span class="s">&#34;show&#34;</span> <span class="o">|]</span>        <span class="o">-&gt;</span> <span class="n">Show</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="o">[|</span> <span class="n">LC</span> <span class="s">&#34;show&#34;</span><span class="o">;</span> <span class="n">Int</span> <span class="n">x</span> <span class="o">|]</span> <span class="o">-&gt;</span> <span class="n">ShowProduct</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="o">[|</span> <span class="n">LC</span> <span class="s">&#34;insert&#34;</span><span class="o">;</span> <span class="n">name</span><span class="o">;</span> <span class="n">Decimal</span> <span class="n">price</span> <span class="o">|]</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Insert</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">price</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="o">[|</span> <span class="n">LC</span> <span class="s">&#34;name&#34;</span><span class="o">;</span> <span class="n">Int</span> <span class="n">id</span><span class="o">;</span> <span class="n">name</span> <span class="o">|]</span> <span class="o">-&gt;</span> <span class="n">NewName</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">name</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="o">[|</span> <span class="n">LC</span> <span class="s">&#34;price&#34;</span><span class="o">;</span> <span class="n">Int</span> <span class="n">id</span><span class="o">;</span> <span class="n">Decimal</span> <span class="n">price</span> <span class="o">|]</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">NewPrice</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">price</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="o">[|</span> <span class="n">LC</span> <span class="s">&#34;delete&#34;</span><span class="o">;</span> <span class="n">Int</span> <span class="n">x</span> <span class="o">|]</span>      <span class="o">-&gt;</span> <span class="n">Delete</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="o">[|</span> <span class="n">LC</span> <span class="s">&#34;exit&#34;</span> <span class="o">|]</span> <span class="o">-&gt;</span> <span class="n">Exit</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="o">_</span>               <span class="o">-&gt;</span> <span class="n">Invalid</span> <span class="n">input</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Helper functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">let</span> <span class="nv">printProduct</span> <span class="n">product</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">printfn</span> <span class="s">&#34;%4d | %25s | %4.2f&#34;</span> <span class="n">product</span><span class="o">.</span><span class="n">Id</span> <span class="n">product</span><span class="o">.</span><span class="n">Name</span> <span class="n">product</span><span class="o">.</span><span class="n">Price</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// CLI Commands
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">let</span> <span class="nv">show</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">printfn</span> <span class="s">&#34;%4s | %25s | %s&#34;</span> <span class="s">&#34;Id&#34;</span> <span class="s">&#34;Name&#34;</span> <span class="s">&#34;Price&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span> <span class="o">|&gt;</span> <span class="nn">DB</span><span class="p">.</span><span class="n">getAll</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">printProduct</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">showProduct</span> <span class="n">db</span> <span class="n">id</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">match</span> <span class="n">db</span> <span class="o">|&gt;</span> <span class="nn">DB</span><span class="p">.</span><span class="n">getById</span> <span class="n">id</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">None</span>   <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s">&#34;Product with id %d doesn&#39;t exists.&#34;</span> <span class="n">id</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Some</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">printProduct</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">insert</span> <span class="n">db</span> <span class="n">name</span> <span class="n">price</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">let</span> <span class="nv">id</span>      <span class="o">=</span> <span class="nn">DB</span><span class="p">.</span><span class="n">nextId</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">        <span class="k">let</span> <span class="nv">product</span> <span class="o">=</span> <span class="nn">Product</span><span class="p">.</span><span class="n">create</span> <span class="n">id</span> <span class="n">name</span> <span class="n">price</span>
</span></span><span class="line"><span class="cl">        <span class="nn">DB</span><span class="p">.</span><span class="n">insert</span> <span class="n">id</span> <span class="n">product</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">updateName</span> <span class="n">db</span> <span class="n">id</span> <span class="n">newName</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nn">DB</span><span class="p">.</span><span class="n">updateId</span> <span class="o">(</span><span class="nn">Product</span><span class="p">.</span><span class="n">withName</span> <span class="n">newName</span><span class="o">)</span> <span class="n">id</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">updatePrice</span> <span class="n">db</span> <span class="n">id</span> <span class="n">newPrice</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nn">DB</span><span class="p">.</span><span class="n">updateId</span> <span class="o">(</span><span class="nn">Product</span><span class="p">.</span><span class="n">withPrice</span> <span class="n">newPrice</span><span class="o">)</span> <span class="n">id</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Execution of CLI Commands
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">let</span> <span class="nv">executeCommand</span> <span class="n">db</span> <span class="n">command</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">match</span> <span class="n">command</span> <span class="k">with</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Show</span>               <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">show</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">ShowProduct</span> <span class="n">x</span>      <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">showProduct</span> <span class="n">db</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Insert</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="n">price</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">insert</span> <span class="n">db</span> <span class="n">name</span> <span class="n">price</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">NewName</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">name</span><span class="o">)</span>   <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">updateName</span> <span class="n">db</span> <span class="n">id</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">NewPrice</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">price</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="n">updatePrice</span> <span class="n">db</span> <span class="n">id</span> <span class="n">price</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Delete</span> <span class="n">x</span>           <span class="o">-&gt;</span> <span class="n">Some</span> <span class="o">&lt;|</span> <span class="nn">DB</span><span class="p">.</span><span class="n">delete</span> <span class="n">x</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Invalid</span> <span class="n">input</span>      <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">printfn</span> <span class="s">&#34;Error: invalid command -- [%s]&#34;</span> <span class="n">input</span>
</span></span><span class="line"><span class="cl">            <span class="n">Some</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">Exit</span> <span class="o">-&gt;</span> <span class="n">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">eval</span> <span class="n">db</span> <span class="n">str</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">parseCommand</span> <span class="n">str</span> <span class="o">|&gt;</span> <span class="n">executeCommand</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">let</span> <span class="nv">main</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">rec</span> <span class="n">loop</span> <span class="n">db</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span> <span class="s">&#34;Command: &#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">stdin</span><span class="o">.</span><span class="n">ReadLine</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="nn">CLI</span><span class="p">.</span><span class="n">eval</span> <span class="n">db</span> <span class="o">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">iter</span> <span class="n">loop</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="n">db</span>
</span></span><span class="line"><span class="cl">    <span class="bp">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Start with some default entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">let</span> <span class="nv">storage</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="nn">Map</span><span class="p">.</span><span class="n">ofList</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">1</span><span class="o">,</span> <span class="nn">Product</span><span class="p">.</span><span class="n">create</span> <span class="n">1</span> <span class="s">&#34;TV&#34;</span> <span class="n">499</span><span class="o">.</span><span class="n">99m</span>
</span></span><span class="line"><span class="cl">        <span class="n">2</span><span class="o">,</span> <span class="nn">Product</span><span class="p">.</span><span class="n">create</span> <span class="n">2</span> <span class="s">&#34;A Book&#34;</span> <span class="n">29</span><span class="o">.</span><span class="n">99m</span>
</span></span><span class="line"><span class="cl">        <span class="n">3</span><span class="o">,</span> <span class="nn">Product</span><span class="p">.</span><span class="n">create</span> <span class="n">3</span> <span class="s">&#34;Game Console&#34;</span> <span class="n">349</span><span class="o">.</span><span class="n">99m</span>
</span></span><span class="line"><span class="cl">    <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Start program loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">main</span> <span class="n">storage</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
    <div class="post-footer">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "davidraab" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </article>

    </main>
  </body>
</html>
